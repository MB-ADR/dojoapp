import 'dart:io';
import 'package:flutter/material.dart';
import 'package:hive_flutter/hive_flutter.dart';
import 'package:image_picker/image_picker.dart';
import 'package:path_provider/path_provider.dart';
import 'models/student.dart';
import 'models/class_schedule.dart';
import 'theme/app_theme.dart';
import 'screens/schedule_management_screen.dart';

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Hive.initFlutter();
  await Hive.openBox('alumnos_box');
  await Hive.openBox('class_schedules_box');
  runApp(const DojoApp());
}

class DojoApp extends StatelessWidget {
  const DojoApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Gesti√≥n Dojo',
      debugShowCheckedModeBanner: false,
      theme: AppTheme.lightTheme,
      home: const PantallaHorarios(),
    );
  }
}

// ==========================================
// PANTALLA 1: HORARIOS
// ==========================================
class PantallaHorarios extends StatefulWidget {
  const PantallaHorarios({super.key});

  @override
  State<PantallaHorarios> createState() => _PantallaHorariosState();
}

class _PantallaHorariosState extends State<PantallaHorarios> {
  List<ClassSchedule> clases = [];
  final Box _scheduleBox = Hive.box('class_schedules_box');

  @override
  void initState() {
    super.initState();
    _cargarClases();
  }

  void _cargarClases() {
    clases.clear();
    if (_scheduleBox.isEmpty) {
      clases = [
        ClassSchedule(
          nombre: '17:00 hs - Infantiles',
          diasDeSemana: [0, 2, 4],
        ),
        ClassSchedule(
          nombre: '19:00 hs - Juveniles',
          diasDeSemana: [1, 3, 5],
        ),
        ClassSchedule(
          nombre: '21:00 hs - Adultos',
          diasDeSemana: [0, 3],
        ),
        ClassSchedule(
          nombre: '22:00 hs - Competidores',
          diasDeSemana: [1, 4],
        ),
      ];
      _guardarClases();
    } else {
      for (var key in _scheduleBox.keys) {
        final saved = _scheduleBox.get(key);
        if (saved != null && saved is Map) {
          clases.add(ClassSchedule.fromMap(Map<String, dynamic>.from(saved as Map)));
        }
      }
    }
  }

  void _guardarClases() {
    _scheduleBox.clear();
    for (int i = 0; i < clases.length; i++) {
      _scheduleBox.put(i, clases[i].toMap());
    }
  }

  void _mostrarDialogoNuevaClase() {
    String nuevaClase = "";
    showDialog(
      context: context,
      builder: (context) {
        return AlertDialog(
          title: const Text("Agregar Nueva Clase"),
          content: TextField(
            autofocus: true,
            decoration: const InputDecoration(
              labelText: "Nombre y Horario",
              hintText: "Ej: 19:00 hs - Juveniles",
            ),
            onChanged: (texto) => nuevaClase = texto,
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text("Cancelar"),
            ),
            ElevatedButton(
              onPressed: () {
                if (nuevaClase.isNotEmpty) {
                  setState(() {
                    clases.add(ClassSchedule(nombre: nuevaClase));
                  });
                  _guardarClases();
                  Navigator.pop(context);
                }
              },
              child: const Text("Agregar"),
            ),
          ],
        );
      },
    );
  }

  void _borrarClase(int index) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text("¬øBorrar clase?"),
        content: Text("Se eliminar√°: ${clases[index].nombre}"),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text("Cancelar"),
          ),
          TextButton(
            onPressed: () {
              setState(() => clases.removeAt(index));
              _guardarClases();
              Navigator.pop(context);
            },
            child: const Text("Borrar", style: TextStyle(color: Colors.red)),
          )
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Horarios Dojo ü•ä'),
        elevation: 0,
      ),
      body: ListView.separated(
        padding: const EdgeInsets.all(16),
        itemCount: clases.length + 1,
        separatorBuilder: (_, __) => const SizedBox(height: 12),
        itemBuilder: (context, index) {
          if (index < clases.length) {
            return _botonHorario(context, clases[index], index);
          }
          return _botonArchivados();
        },
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: _mostrarDialogoNuevaClase,
        child: const Icon(Icons.add),
      ),
    );
  }

  Widget _botonHorario(BuildContext context, ClassSchedule clase, int index) {
    return Dismissible(
      key: Key(clase.nombre),
      background: Container(
        decoration: BoxDecoration(
          color: Colors.red,
          borderRadius: BorderRadius.circular(12),
        ),
        alignment: Alignment.centerRight,
        padding: const EdgeInsets.only(right: 20),
        child: const Icon(Icons.delete, color: Colors.white),
      ),
      onDismissed: (_) => setState(() => clases.removeAt(index)),
      child: Card(
        child: InkWell(
          onTap: () {
            Navigator.push(
              context,
              MaterialPageRoute(builder: (_) => PantallaClase(horario: clase)),
            ).then((_) => setState(() {}));
          },
          child: Padding(
            padding: const EdgeInsets.all(16),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      clase.nombre,
                      style: const TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 4),
                    const Text(
                      'Toca para ver alumnos',
                      style: TextStyle(fontSize: 12, color: Colors.grey),
                    ),
                  ],
                ),
                IconButton(
                  icon: const Icon(Icons.more_vert, color: Colors.grey),
                  onPressed: () => _borrarClase(index),
                )
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _botonArchivados() {
    return Card(
      color: Colors.grey[200],
      child: InkWell(
        onTap: () {
          Navigator.push(
            context,
            MaterialPageRoute(builder: (_) => const PantallaArchivados()),
          ).then((_) => setState(() {}));
        },
        child: const Padding(
          padding: EdgeInsets.all(16),
          child: Row(
            children: [
              Icon(Icons.archive, color: Colors.grey, size: 28),
              SizedBox(width: 16),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'Alumnos Archivados',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                    SizedBox(height: 4),
                    Text(
                      'Gestionar alumnos inactivos',
                      style: TextStyle(fontSize: 12, color: Colors.grey),
                    ),
                  ],
                ),
              ),
              Icon(Icons.arrow_forward_ios, size: 16, color: Colors.grey),
            ],
          ),
        ),
      ),
    );
  }
}

// ==========================================
// PANTALLA 2: LISTA DE ALUMNOS
// ==========================================
class PantallaClase extends StatefulWidget {
  final ClassSchedule horario;
  const PantallaClase({super.key, required this.horario});

  @override
  State<PantallaClase> createState() => _PantallaClaseState();
}

class _PantallaClaseState extends State<PantallaClase> {
  late List<Student> alumnos;
  late ClassSchedule _schedule;
  final Box _box = Hive.box('alumnos_box');
  final Box _scheduleBox = Hive.box('class_schedules_box');
  bool _cargando = true;

  @override
  void initState() {
    super.initState();
    _schedule = widget.horario;
    _cargarAlumnos();
  }

  void _cargarAlumnos() {
    final saved = _box.get(_schedule.nombre);
    if (saved != null && saved is List) {
      alumnos = (saved)
          .map((e) => Student.fromMap(Map<String, dynamic>.from(e as Map)))
          .where((s) => !s.isArchived)
          .toList();
    } else {
      alumnos = [
        Student(nombre: 'Juan Perez'),
        Student(nombre: 'Maria Gonzalez'),
      ];
      _guardarAlumnos();
    }
    setState(() => _cargando = false);
  }

  void _guardarAlumnos() {
    _box.put(_schedule.nombre, alumnos.map((s) => s.toMap()).toList());
  }

  void _guardarSchedule(ClassSchedule updated) {
    _schedule = updated;
    // Guardar la configuraci√≥n actualizada en Hive
    for (int i = 0; i < _scheduleBox.length; i++) {
      final saved = _scheduleBox.get(i);
      if (saved != null && saved is Map) {
        final schedule = ClassSchedule.fromMap(Map<String, dynamic>.from(saved as Map));
        if (schedule.nombre == _schedule.nombre) {
          _scheduleBox.put(i, _schedule.toMap());
          break;
        }
      }
    }
    setState(() {});
  }

  void _abrirConfiguracion() {
    Navigator.push<ClassSchedule?>(
      context,
      MaterialPageRoute(
        builder: (_) => ScheduleManagementScreen(
          schedule: _schedule,
          onSave: _guardarSchedule,
        ),
      ),
    );
  }

  void _eliminarAlumno(int index) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Archivar alumno'),
        content: Text('¬øDeseas archivar a ${alumnos[index].nombre}?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('Cancelar'),
          ),
          TextButton(
            onPressed: () {
              setState(() {
                alumnos[index].isArchived = true;
              });
              _guardarAlumnos();
              Navigator.pop(context);
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(content: Text('${alumnos[index].nombre} archivado')),
              );
            },
            child: const Text('Archivar', style: TextStyle(color: Colors.red)),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final now = DateTime.now();

    return Scaffold(
      appBar: AppBar(
        title: Text(_schedule.nombre),
        actions: [
          IconButton(
            icon: const Icon(Icons.calendar_today),
            onPressed: _abrirConfiguracion,
          ),
        ],
      ),
      body: _cargando
          ? const Center(child: CircularProgressIndicator())
          : alumnos.isEmpty
              ? Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.people, size: 64, color: Colors.grey[300]),
                      const SizedBox(height: 16),
                      const Text('No hay alumnos en esta clase'),
                    ],
                  ),
                )
              : ListView.builder(
                  padding: const EdgeInsets.all(8),
                  itemCount: alumnos.length,
                  itemBuilder: (context, index) {
                    final alumno = alumnos[index];
                    final asistenciasEsteMes = alumno.getAsistenciasDelMes(now.month, now.year);
                    // CORREGIDO: Calcular total POR ALUMNO dentro del builder
                    final totalClasesEsteMes = _schedule.calculateTotalClasses(
                      now.month,
                      now.year,
                      alumno.creationDate,
                    );

                    return Card(
                      margin: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                      child: ListTile(
                        leading: CircleAvatar(
                          backgroundColor: Colors.red[100],
                          backgroundImage: alumno.photoPath != null
                              ? FileImage(File(alumno.photoPath!)) as ImageProvider
                              : null,
                          child: alumno.photoPath == null
                              ? Text(
                                  alumno.nombre[0].toUpperCase(),
                                  style: const TextStyle(fontWeight: FontWeight.bold),
                                )
                              : null,
                        ),
                        title: Text(
                          alumno.nombre,
                          style: const TextStyle(fontWeight: FontWeight.w600),
                        ),
                        subtitle: Row(
                          children: [
                            const Icon(Icons.check_circle, size: 14, color: Colors.blue),
                            const SizedBox(width: 4),
                            Text('$asistenciasEsteMes/$totalClasesEsteMes'),
                            const SizedBox(width: 12),
                            const Icon(Icons.star, size: 14, color: Colors.orange),
                            const SizedBox(width: 4),
                            Text('${alumno.stars}'),
                          ],
                        ),
                        trailing: PopupMenuButton(
                          itemBuilder: (_) => [
                            PopupMenuItem(
                              child: const Text('Ver ficha'),
                              onTap: () => _abrirFicha(index),
                            ),
                            PopupMenuItem(
                              child: const Text('Archivar', style: TextStyle(color: Colors.red)),
                              onTap: () => _eliminarAlumno(index),
                            ),
                          ],
                        ),
                        onTap: () => _abrirFicha(index),
                      ),
                    );
                  },
                ),
      floatingActionButton: FloatingActionButton(
        onPressed: _agregarAlumno,
        child: const Icon(Icons.add),
      ),
    );
  }

  Future<void> _abrirFicha(int index) async {
    final actualizado = await Navigator.push<Student?>(
      context,
      MaterialPageRoute(
        builder: (_) => PantallaFichaAlumno(
          alumno: alumnos[index],
          schedule: _schedule,
        ),
      ),
    );
    if (actualizado != null) {
      setState(() => alumnos[index] = actualizado);
      _guardarAlumnos();
    }
  }

  Future<void> _agregarAlumno() async {
    final nuevo = await Navigator.push<Student?>(
      context,
      MaterialPageRoute(
        builder: (_) => const PantallaFichaAlumno(alumno: null, schedule: null),
      ),
    );
    if (nuevo != null) {
      setState(() => alumnos.add(nuevo));
      _guardarAlumnos();
    }
  }
}

// ==========================================
// PANTALLA 3: FICHA COMPLETA
// ==========================================
class PantallaFichaAlumno extends StatefulWidget {
  final Student? alumno;
  final ClassSchedule? schedule;
  const PantallaFichaAlumno({super.key, required this.alumno, this.schedule});

  @override
  State<PantallaFichaAlumno> createState() => _PantallaFichaAlumnoState();
}

class _PantallaFichaAlumnoState extends State<PantallaFichaAlumno> {
  late Student student;
  late TextEditingController _nombreController;
  late TextEditingController _padreNombreController;
  late TextEditingController _padreTelController;
  late TextEditingController _madreNombreController;
  late TextEditingController _madreTelController;
  late TextEditingController _obsController;

  @override
  void initState() {
    super.initState();
    student = widget.alumno ?? Student(nombre: '');
    _nombreController = TextEditingController(text: student.nombre);
    _padreNombreController = TextEditingController(text: student.padreNombre ?? '');
    _padreTelController = TextEditingController(text: student.padreTel ?? '');
    _madreNombreController = TextEditingController(text: student.madreNombre ?? '');
    _madreTelController = TextEditingController(text: student.madreTel ?? '');
    _obsController = TextEditingController(text: student.observaciones ?? '');
  }

  @override
  void dispose() {
    _nombreController.dispose();
    _padreNombreController.dispose();
    _padreTelController.dispose();
    _madreNombreController.dispose();
    _madreTelController.dispose();
    _obsController.dispose();
    super.dispose();
  }

  Future<void> _tomarFoto() async {
    try {
      final ImagePicker picker = ImagePicker();
      final XFile? foto = await picker.pickImage(
        source: ImageSource.camera,
        imageQuality: 85,
        maxWidth: 1200,
      );
      if (foto == null) return;
      final Directory appDir = await getApplicationDocumentsDirectory();
      final String fileName = 'alumno_${DateTime.now().millisecondsSinceEpoch}.jpg';
      final File saved = await File(foto.path).copy('${appDir.path}/$fileName');
      setState(() => student.photoPath = saved.path);
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Error: $e')),
      );
    }
  }

  void _marcarAsistencia() {
    // CORREGIDO: Validar que sea un d√≠a de clase
    if (!widget.schedule?.esHoyDiaDeClase() ?? false) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Hoy no hay clase programada'),
          duration: Duration(seconds: 2),
        ),
      );
      return;
    }

    setState(() {
      if (student.fuePresenteHoy()) {
        student.quitarPresenteHoy();
      } else {
        student.agregarPresenteHoy();
      }
    });
  }

  void _agregarEstrella() => setState(() => student.stars++);
  void _quitarEstrella() => setState(() {
    if (student.stars > 0) student.stars--;
  });

  void _guardarYSalir() {
    student.nombre = _nombreController.text;
    student.padreNombre = _padreNombreController.text;
    student.padreTel = _padreTelController.text;
    student.madreNombre = _madreNombreController.text;
    student.madreTel = _madreTelController.text;
    student.observaciones = _obsController.text;
    Navigator.of(context).pop(student);
  }

  Future<void> _archivarAlumno() async {
    final confirm = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Archivar Alumno'),
        content: Text('¬øDeseas archivar a ${student.nombre}?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: const Text('Cancelar'),
          ),
          TextButton(
            onPressed: () => Navigator.pop(context, true),
            child: const Text('Archivar', style: TextStyle(color: Colors.red)),
          ),
        ],
      ),
    );

    if (confirm == true) {
      student.isArchived = true;
      Navigator.of(context).pop(student);
    }
  }

  String _formatearFecha(DateTime dt) {
    return "${dt.day.toString().padLeft(2, '0')}/${dt.month.toString().padLeft(2, '0')}/${dt.year}";
  }

  @override
  Widget build(BuildContext context) {
    final now = DateTime.now();
    final asistenciasEsteMes = student.getAsistenciasDelMes(now.month, now.year);
    final totalClases = widget.schedule?.calculateTotalClasses(
          now.month,
          now.year,
          student.creationDate,
        ) ??
        0;
    
    // CORREGIDO: Validar si hoy es d√≠a de clase para habilitar/deshabilitar bot√≥n
    final esHoyDiaDeClase = widget.schedule?.esHoyDiaDeClase() ?? false;
    final puedeMarcarAsistencia = esHoyDiaDeClase;

    return Scaffold(
      appBar: AppBar(
        title: const Text('Ficha del Alumno'),
        actions: [
          IconButton(
            icon: const Icon(Icons.save),
            onPressed: _guardarYSalir,
          ),
          IconButton(
            icon: const Icon(Icons.delete, color: Colors.red),
            onPressed: _archivarAlumno,
          ),
        ],
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            // FOTO
            GestureDetector(
              onTap: _tomarFoto,
              child: Stack(
                alignment: Alignment.bottomRight,
                children: [
                  CircleAvatar(
                    radius: 60,
                    backgroundColor: Colors.red[100],
                    backgroundImage: student.photoPath != null
                        ? FileImage(File(student.photoPath!)) as ImageProvider
                        : null,
                    child: student.photoPath == null
                        ? const Icon(Icons.camera_alt, size: 40, color: Colors.grey)
                        : null,
                  ),
                  Container(
                    decoration: const BoxDecoration(
                      color: AppTheme.primaryColor,
                      shape: BoxShape.circle,
                    ),
                    padding: const EdgeInsets.all(8),
                    child: const Icon(
                      Icons.edit,
                      color: Colors.white,
                      size: 20,
                    ),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 8),
            const Text(
              'Tocar para cambiar foto',
              style: TextStyle(color: Colors.grey, fontSize: 12),
            ),
            const SizedBox(height: 24),

            // NOMBRE
            TextField(
              controller: _nombreController,
              decoration: const InputDecoration(
                labelText: 'Nombre y Apellido',
                prefixIcon: Icon(Icons.person),
              ),
            ),
            const SizedBox(height: 20),

            // DATOS PADRE
            _buildDatosParentales(
              'PADRE',
              _padreNombreController,
              _padreTelController,
            ),
            const SizedBox(height: 16),

            // DATOS MADRE
            _buildDatosParentales(
              'MADRE',
              _madreNombreController,
              _madreTelController,
            ),
            const SizedBox(height: 16),

            // OBSERVACIONES
            TextField(
              controller: _obsController,
              maxLines: 3,
              decoration: const InputDecoration(
                labelText: 'Observaciones (Zurdo/Diestro, Alergias...)',
              ),
            ),
            const Divider(height: 32, thickness: 2),

            // SISTEMA DE RECOMPENSAS
            const Text(
              'Sistema de Recompensas',
              style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
            ),
            const SizedBox(height: 20),

            // ASISTENCIAS (CON FRACCI√ìN)
            Card(
              color: Colors.blue[50],
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: Column(
                  children: [
                    const Text(
                      'Asistencias',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 16),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                      children: [
                        Column(
                          children: [
                            Text(
                              '$asistenciasEsteMes/$totalClases',
                              style: const TextStyle(
                                fontSize: 48,
                                fontWeight: FontWeight.bold,
                                color: Colors.blue,
                              ),
                            ),
                            Text(
                              'Asistencias ${_mesActual(now.month)}',
                              style: const TextStyle(color: Colors.grey, fontSize: 12),
                            ),
                          ],
                        ),
                        // CORREGIDO: Bot√≥n deshabilitado si no es d√≠a de clase
                        ElevatedButton.icon(
                          style: ElevatedButton.styleFrom(
                            backgroundColor: !puedeMarcarAsistencia
                                ? Colors.grey
                                : student.fuePresenteHoy()
                                    ? Colors.red
                                    : AppTheme.successColor,
                            padding: const EdgeInsets.all(16),
                          ),
                          onPressed: puedeMarcarAsistencia ? _marcarAsistencia : null,
                          icon: Icon(student.fuePresenteHoy() ? Icons.close : Icons.check_circle),
                          label: Text(
                            !puedeMarcarAsistencia
                                ? 'SIN\nCLASE'
                                : student.fuePresenteHoy()
                                    ? 'ANULAR\nPRESENTE'
                                    : 'PRESENTE\nHOY',
                            textAlign: TextAlign.center,
                            style: const TextStyle(fontSize: 12, fontWeight: FontWeight.bold),
                          ),
                        )
                      ],
                    ),
                  ],
                ),
              ),
            ),
            const SizedBox(height: 20),

            // ESTRELLAS
            Card(
              color: Colors.orange[50],
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: Column(
                  children: [
                    const Text(
                      'Estrellas (M√©ritos)',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 16),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                      children: [
                        IconButton(
                          icon: const Icon(Icons.remove_circle, color: Colors.red, size: 40),
                          onPressed: _quitarEstrella,
                        ),
                        Column(
                          children: [
                            Text(
                              '${student.stars}',
                              style: const TextStyle(
                                fontSize: 48,
                                fontWeight: FontWeight.bold,
                                color: AppTheme.accentColor,
                              ),
                            ),
                            const Text(
                              'estrellas',
                              style: TextStyle(color: Colors.grey, fontSize: 12),
                            ),
                          ],
                        ),
                        IconButton(
                          icon: const Icon(Icons.add_circle, color: AppTheme.successColor, size: 40),
                          onPressed: _agregarEstrella,
                        ),
                      ],
                    ),
                    const SizedBox(height: 12),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: List.generate(10, (index) {
                        return Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 2),
                          child: Icon(
                            index < student.stars ? Icons.star : Icons.star_border,
                            color: AppTheme.accentColor,
                            size: 20,
                          ),
                        );
                      }),
                    ),
                  ],
                ),
              ),
            ),
            const SizedBox(height: 20),
            if (student.attendanceHistory.isNotEmpty)
              Card(
                child: Padding(
                  padding: const EdgeInsets.all(16),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text(
                        'Historial de Asistencia',
                        style: TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      const SizedBox(height: 12),
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: student.attendanceHistory
                            .map(
                              (dt) => Padding(
                                padding: const EdgeInsets.symmetric(vertical: 4),
                                child: Row(
                                  children: [
                                    const Icon(Icons.check_circle, size: 16, color: AppTheme.successColor),
                                    const SizedBox(width: 8),
                                    Text(_formatearFecha(dt)),
                                  ],
                                ),
                              ),
                            )
                            .toList(),
                      ),
                    ],
                  ),
                ),
              ),
            const SizedBox(height: 32),
          ],
        ),
      ),
    );
  }

  Widget _buildDatosParentales(
    String titulo,
    TextEditingController nombre,
    TextEditingController tel,
  ) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(12),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'DATOS $titulo',
              style: const TextStyle(
                fontSize: 12,
                fontWeight: FontWeight.bold,
                color: Colors.grey,
              ),
            ),
            const SizedBox(height: 12),
            TextField(
              controller: nombre,
              decoration: InputDecoration(
                labelText: 'Nombre $titulo',
                prefixIcon: const Icon(Icons.person),
              ),
            ),
            const SizedBox(height: 12),
            TextField(
              controller: tel,
              keyboardType: TextInputType.phone,
              decoration: InputDecoration(
                labelText: 'Tel√©fono $titulo',
                prefixIcon: const Icon(Icons.phone),
              ),
            ),
          ],
        ),
      ),
    );
  }

  String _mesActual(int month) {
    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    return meses[month - 1];
  }
}

// ==========================================
// PANTALLA 4: ALUMNOS ARCHIVADOS (MEJORADA)
// ==========================================
class PantallaArchivados extends StatefulWidget {
  const PantallaArchivados({super.key});

  @override
  State<PantallaArchivados> createState() => _PantallaArchivadosState();
}

class _PantallaArchivadosState extends State<PantallaArchivados> {
  final Box _box = Hive.box('alumnos_box');
  List<String> clases = [];

  @override
  void initState() {
    super.initState();
    _cargarClases();
  }

  void _cargarClases() {
    clases = _box.keys.cast<String>().toList();
  }

  List<Student> _obtenerArchivados() {
    List<Student> archivados = [];
    for (var key in _box.keys) {
      final saved = _box.get(key);
      if (saved != null && saved is List) {
        final students = (saved)
            .map((e) => Student.fromMap(Map<String, dynamic>.from(e as Map)))
            .where((s) => s.isArchived)
            .toList();
        archivados.addAll(students);
      }
    }
    return archivados;
  }

  void _reasignarAlumno(Student alumno) {
    showModalBottomSheet(
      context: context,
      builder: (context) => ListView.builder(
        itemCount: clases.length,
        itemBuilder: (context, index) {
          return ListTile(
            title: Text(clases[index]),
            onTap: () {
              _moverAClase(alumno, clases[index]);
              Navigator.pop(context);
            },
          );
        },
      ),
    );
  }

  void _moverAClase(Student alumno, String claseDestino) {
    alumno.isArchived = false;

    final saved = _box.get(claseDestino);
    List<Map<String, dynamic>> alumnos = [];
    if (saved != null && saved is List) {
      alumnos = (saved).map((e) => Map<String, dynamic>.from(e as Map)).toList();
    }
    alumnos.add(alumno.toMap());
    _box.put(claseDestino, alumnos);

    setState(() {});
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text('${alumno.nombre} reasignado a $claseDestino'),
        backgroundColor: AppTheme.successColor,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final archivados = _obtenerArchivados();

    return Scaffold(
      appBar: AppBar(title: const Text('Alumnos Archivados')),
      body: archivados.isEmpty
          ? Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(Icons.archive, size: 64, color: Colors.grey[300]),
                  const SizedBox(height: 16),
                  const Text('No hay alumnos archivados'),
                ],
              ),
            )
          : ListView.builder(
              padding: const EdgeInsets.all(8),
              itemCount: archivados.length,
              itemBuilder: (context, index) {
                final alumno = archivados[index];
                return Card(
                  margin: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  child: ListTile(
                    leading: CircleAvatar(
                      backgroundColor: Colors.grey[300],
                      backgroundImage: alumno.photoPath != null
                          ? FileImage(File(alumno.photoPath!)) as ImageProvider
                          : null,
                      child: alumno.photoPath == null
                          ? Text(alumno.nombre[0].toUpperCase(),
                              style: const TextStyle(fontWeight: FontWeight.bold))
                          : null,
                    ),
                    title: Text(alumno.nombre),
                    subtitle: Row(
                      children: [
                        const Icon(Icons.check_circle, size: 14, color: Colors.blue),
                        const SizedBox(width: 4),
                        Text('${alumno.asistenciasTotal}'),
                        const SizedBox(width: 12),
                        const Icon(Icons.star, size: 14, color: Colors.orange),
                        const SizedBox(width: 4),
                        Text('${alumno.stars}'),
                      ],
                    ),
                    trailing: ElevatedButton(
                      style: ElevatedButton.styleFrom(backgroundColor: AppTheme.successColor),
                      onPressed: () => _reasignarAlumno(alumno),
                      child: const Text('Reactivar'),
                    ),
                  ),
                );
              },
            ),
    );
  }
}